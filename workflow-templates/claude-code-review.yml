name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install tupi-ai plugin
        run: |
          mkdir -p .claude
          cat > .claude/settings.json << 'EOF'
          {
            "extraKnownMarketplaces": {
              "tupi": {
                "source": {
                  "source": "github",
                  "repo": "tupinamba-energia/tupi-ai"
                }
              }
            },
            "enabledPlugins": {
              "engineering@tupi": true
            }
          }
          EOF

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Review this pull request using the specialized engineering agents:
            - security-auditor: Security vulnerabilities, OWASP, auth issues
            - performance-optimizer: Performance bottlenecks, caching, optimization
            - debugger-expert: Potential bugs and error handling
            - typescript-guardian: TypeScript type safety (for .ts/.tsx files)
            - javascript-architect: JavaScript patterns (for .js/.jsx files)
            - python-mentor: Python best practices (for .py files)
            - elixir-master: Elixir/OTP patterns (for .ex/.exs files)
            - ai-alchemist: AI/ML code quality (for LLM-related code)
            - observability-specialist: Monitoring and logging
            - devops-troubleshooter: Infrastructure and CI/CD

            Use the appropriate agent based on the file types and concerns in the PR.
            Use the repository's CLAUDE.md for guidance on style and conventions.
            Be constructive and helpful in your feedback.

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          # Agents are loaded from tupi-ai plugin via .claude/settings.json
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Read,Grep,Glob,Task"'
